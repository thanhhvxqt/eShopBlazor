@page "/cart"
@using System.Net;
@inject IToastService _toastSvc;
@using Newtonsoft.Json
@inject IJSRuntime JSRuntime
@inject Blazored.SessionStorage.ISyncSessionStorageService sessionStorage
@inject Microsoft.Extensions.Configuration.IConfiguration config;
@inject NavigationManager NavigationManager
@layout WebLayout;
@inject IOnChangeService _OCSvc;
@implements IDisposable
<style>
    .viewProduct, .addProduct {
        border: 0;
        font-weight: 700;
        padding: 9px 5px;
        background: #ffd800;
        -webkit-border-radius: 5px;
        -moz-border-radius: 5px;
        border-radius: 5px;
        display: block;
        width: 186px;
        margin: 0 auto;
        color: #0e0e0e;
        text-align: center;
    }
</style>

@*<h1>Cart</h1>*@
@if (giohang.cartItems != null)
{
    <div class="shopping_cart_area mt-60">
        <div class="container">
            <form action="#">
                <div class="row">
                    <div class="col-12">
                        <div class="table_desc">
                            <div class="cart_page table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th class="product_thumb">Image</th>
                                            <th class="product_name">Product</th>
                                            <th class="product-price">Price</th>
                                            <th class="product_quantity">Quantity</th>
                                            <th class="product_total">Total</th>
                                            <th class="product_remove">Remove</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in giohang.cartItems)
                                        {
                                            <tr>
                                                @{
                                                    if (item.product.Photos.Any())
                                                    {
                                                        temp = imgUrl + item.product.Photos.FirstOrDefault().FileName;
                                                    }
                                                    else
                                                    {
                                                        temp = imgUrl + "/nophoto.png";
                                                    }
                                                }
                                                <td class="product_thumb"><a href="#"><img src="@temp" alt=""></a></td>
                                                <td class="product_name"><a href="#">@item.product.Name</a></td>
                                                <td class="product-price">@item.product.Gia</td>
                                                <td class="product_quantity">
                                                    <label>Quantity</label> <input type="number" id="txtQuantity_@item.product.Id"
                                                                           @oninput="(e) => item.quantity = int.Parse(e.Value.ToString())"
                                                                           @onchange="() => UpdateCart(item)" value="@item.quantity" />
                                                </td>
                                                <td class="product_total">@item.Sotien</td>
                                                <td class="product_remove">
                                                    <a href="javascript:return false;" @onclick="() => DeleteCart(item)"
                                               onmouseup="delCart(@item.product.Id)"><i class="ion-android-close"></i></a>
                                                </td>
                                            </tr>
                                        }



                                    </tbody>
                                </table>
                            </div>
                            @* <div class="cart_submit">
                        <button type="submit">update cart</button>
                        </div>    *@
                        </div>
                    </div>
                </div>
                <div class="coupon_area">
                    <div class="row">

                        <div class="col-lg-6 col-md-6">
                            <div class="coupon_code right">
                                <h3>Cart Totals</h3>

                                <div class="cart_subtotal">
                                    <p>Total</p>
                                    <p class="cart_amount">@giohang.TongTien</p>
                                </div>
                                <AuthorizeView>
                                    <Authorized>
                                        @if (IsHaveItemInCart() == true)
                                        {
                                            <div class="checkout_btn">
                                                <a class="btn" href="/checkout">Đặt hàng</a>
                                            </div>

                                        }
                                        else
                                        {
                                            <div class="checkout_btn">
                                                <a class="btn" href="/">Cần ít nhất một sản phẩm để đặt hàng</a>
                                            </div>
                                        }
                                    </Authorized>
                                    <NotAuthorized>
                                        <div class="checkout_btn">
                                            <a href="/login">Bạn cần đăng nhập để đặt hàng</a>
                                        </div>
                                    </NotAuthorized>
                                </AuthorizeView>


                            </div>
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </div>
}
else
{
    <p>Giỏ hàng trống</p>
}
@*@if(giohang.cartItems != null){
    <table class="table">
    <tr>
        <th>Title</th>
        <th>Image</th>
        <th>Quantity</th>
        <th>Price</th>
        <th>Total</th>
        <th></th>
    </tr>
    @{
                @foreach (var item in giohang.cartItems)
        {
                    @if (item != null)
            {
                        <tr>
                            <td>
                                @item.product.Name
                            </td>
                            <td>
                                @{
                if (item.product.Photos.Any())
                {
                    temp = imgUrl + item.product.Photos.FirstOrDefault().FileName;
                }
                else
                {
                    temp = imgUrl + "/nophoto.png";
                }
                    }
                    <img src="@temp" class="img-responsive" style="width:150px;height:150px"/>
                            </td>
                            <td>
                                <input type="number" id="txtQuantity_@item.product.Id"
                                       @oninput="(e) => item.quantity = int.Parse(e.Value.ToString())"
                                       @onchange="() => UpdateCart(item)" value="@item.quantity" />
                            </td>
                            <td id="tdGia_@item.product.Id">@item.product.Gia</td>
                            <td id="tdTien_@item.product.Id">@item.Sotien</td>
                            <td>
                                <a href="javascript:return false;" @onclick="() => DeleteCart(item)"
                           onmouseup="delCart(@item.product.Id)">Delete</a>
                            </td>
                        </tr>
            }
        }
    }
</table>
<p>
    <div>Tổng tiền: <span id="spTotal">@giohang.TongTien</span></div>
</p>
}
else{
        <p>Giỏ hàng trống</p>
    }*@
<p>
    @*@if (@emailAddress != null && @emailAddress != "")
    {
    <button class="btn btn-link" @onclick="OrderCart">Đặt hàng</button>
    }
    else
    {
    <span>Bạn cần đăng nhập để đặt hàng</span>
    }*@
</p>
@code {
    private string emailAddress;
    public PostCartModel giohang;
    private double total = 0;
    protected string imgUrl = "";
    protected string temp = "";

    protected override void OnInitialized()
    {
        emailAddress = sessionStorage.GetItem<string>("Email");//get key cart
        var cart = sessionStorage.GetItem<string>("cart");//get key cart

        if (cart == null)
        {
            giohang = new PostCartModel();
        }
        else
        {
            giohang = JsonConvert.DeserializeObject<PostCartModel>(cart);
        }

        imgUrl = config.GetSection("API")["ImgUrl"].ToString();
        _OCSvc.OnChange += StateHasChanged;
    }
    public void Dispose()
    {
        _OCSvc.OnChange -= StateHasChanged;
    }
    public bool IsHaveItemInCart()
    {
        if (sessionStorage.GetItem<string>("cart") != null || sessionStorage.GetItem<string>("cart") == "")
        {
            return true;
        }
        return false;
    }
    private void UpdateCart(CartItem item)
    {
        item.Sotien = (double)(item.quantity * item.product.Gia);
        giohang.TongTien = Tinhtien(giohang.cartItems);
        sessionStorage.SetItem("cart", JsonConvert.SerializeObject(giohang));
    }

    private void DeleteCart(CartItem item)
    {
        giohang.cartItems.Remove(item);
        giohang.TongTien = Tinhtien(giohang.cartItems);
        sessionStorage.SetItem("cart", JsonConvert.SerializeObject(giohang));
        _OCSvc.Invoke();
    }



    private double Tinhtien(List<CartItem> listCart)
    {
        double tongtien = 0;
        if (listCart != null)
        {
            for (int i = 0; i < listCart.Count; i++)
            {
                tongtien += listCart[i].Sotien;
            }
        }
        return tongtien;
    }
}

